<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>clothing.deals</title>
    <style>
        :root {--bg-color: #fff;--text-color: #333;--accent-color: #07f;--border-color: #dee2e6;--stripe-color: #f8f9fa;--font-sans: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;--progress-bg: #e9ecef;--progress-bar: #007bff;--nested-border-color: #e9ecef;}
        body {font-family: var(--font-sans);background-color: var(--bg-color);color: var(--text-color);margin: 0;padding: .5rem;line-height: 1.2;font-size: .85rem;}
        h1 {font-size: 1.5rem;font-weight: 400;margin: 0 0 .5rem;text-align: center;}
        form {display: flex;flex-wrap: wrap;gap: .25rem;margin-bottom: .5rem;padding: .5rem;background: var(--stripe-color);border-radius: 4px;box-shadow: 0 1px 3px rgba(0,0,0,.1);align-items: flex-end;}
        .filter-group {display: flex;flex-wrap: nowrap;gap: .25rem;align-items: flex-end;}
        form > div {flex: 0 0 auto;min-width: 0;}
        label {display: block;font-size: .75rem;margin-bottom: .1rem;color: #495057;text-align: center;}
        input, select {padding: .3rem;border: 1px solid var(--border-color);border-radius: 4px;font-size: .85rem;box-sizing: border-box;text-align: center;}
        input#min_discount { width: 3rem } input#min_price, input#max_price { width: 5rem } select#group_by { width: 9.5rem } select#gender { width: 5rem } select#sort_by { width: 11rem } input#brands, input#sizes { width: 10rem }
        .results-header {text-align: center;margin-bottom: .3rem;} .results-header h2 {font-size: 1rem;font-weight: 400;margin: 0;} .results-header p {font-size: .75rem;color: #6c757d;margin: .1rem 0 0;}
        .nested-list {margin: 0;overflow-x: auto;}
        .group-header {cursor: pointer;padding: .3rem .5rem;margin: 0;display: flex;align-items: center;border-bottom: 1px solid var(--border-color);}
        .group-header:hover {background: #e9ecef;}
        .group-header .toggle {width: .8rem;height: .8rem;margin-right: .4rem;font-size: .7rem;text-align: center;line-height: .8rem;}
        .group-outer {font-weight: 600;background: var(--stripe-color);}
        .group-inner {font-weight: 500;background: #fff;margin-left: 1.5rem;}
        .product-list {margin-left: 3rem;padding-left: 0.5rem;border-left: 2px solid var(--nested-border-color);}
        table {border-collapse: collapse;font-size: .8rem;width: 100%;table-layout: fixed;}
        th, td {padding: .2rem .3rem;text-align: left;border-bottom: 1px solid var(--border-color);overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}
        th {background: var(--stripe-color);font-weight: 600;position: sticky;top: 0;z-index: 1;text-align: left;}
        td.discount { text-align: center; } tr:nth-child(even) { background: var(--stripe-color) } tr:hover { background: #e9ecef } .discount { font-weight: 700 } .spacer { width: auto; padding: 0 }
        a { color: var(--accent-color); text-decoration: none } a:hover { text-decoration: underline } .hidden { display: none }
        .progress-container {width: 100%;max-width: 400px;height: 4px;background: var(--progress-bg);border-radius: 2px;margin: .5rem auto;overflow: hidden;display: none;}
        .progress-bar {width: 100%;height: 100%;background: var(--progress-bar);animation: indeterminate 1.5s linear infinite;}
        @keyframes indeterminate { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    </style>
    <script>
        let currentProducts = [];
        let groupedProducts = new Map();
        let expandedIds = new Set();

        function toggleSection(id) {
            const section = document.getElementById(id);
            const toggle = document.querySelector(`[data-toggle="${id}"]`);
            if (!section || !toggle) return;
            
            if (section.classList.contains("hidden")) {
                section.classList.remove("hidden");
                toggle.textContent = "âˆ’";
                if (section.innerHTML === '' && groupedProducts.has(id)) {
                    section.innerHTML = buildTable(groupedProducts.get(id));
                }
                expandedIds.add(id);
            } else {
                section.classList.add("hidden");
                toggle.textContent = "+";
                expandedIds.delete(id);
            }
        }

        function getCategory(p) {
            return (p.category || 'Unknown Category').replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        function getBrandTitle(p) {
            if (!p.brand) return 'Unknown Brand';
            return p.brand.charAt(0).toUpperCase() + p.brand.slice(1);
        }

        function getGroupedData(group_by, products) {
            let type, groups = {};
            if (group_by === 'category_brand') {
                type = 'nested'; products.forEach(p => { const o = getCategory(p), i = getBrandTitle(p); if (!groups[o]) groups[o] = {}; if (!groups[o][i]) groups[o][i] = []; groups[o][i].push(p); });
            } else if (group_by === 'brand_category') {
                type = 'nested'; products.forEach(p => { const o = getBrandTitle(p), i = getCategory(p); if (!groups[o]) groups[o] = {}; if (!groups[o][i]) groups[o][i] = []; groups[o][i].push(p); });
            } else if (group_by === 'category') {
                type = 'flat'; products.forEach(p => { const k = getCategory(p); if (!groups[k]) groups[k] = []; groups[k].push(p); });
            } else { // Default to brand
                type = 'flat'; products.forEach(p => { const k = getBrandTitle(p); if (!groups[k]) groups[k] = []; groups[k].push(p); });
            }
            const sorted = {};
            Object.keys(groups).sort((a, b) => a.localeCompare(b)).forEach(k => {
                if (type === 'nested') { sorted[k] = Object.fromEntries(Object.entries(groups[k]).sort((a, b) => a[0].localeCompare(b[0]))); } else { sorted[k] = groups[k]; }
            });
            return {type, groups: sorted};
        }

        function buildTable(products) {
            let html = '<table><thead><tr>' +
                '<th>Discount</th><th>Product</th><th>Gender</th><th>Category</th><th>Sizes</th><th>Sale</th><th>Original</th><th class="spacer"></th>' +
                '</tr></thead><tbody>';
            products.forEach(p => {
                const hue = Math.min(p.discount / 90, 1) * 120;
                const salePrice = p.lowest ? `$${Math.round(p.lowest)}` : '-';
                const regularPrice = p.regular ? `$${Math.round(p.regular)}` : '-';
                const gender = p.gender ? p.gender.charAt(0).toUpperCase() + p.gender.slice(1) : '-';
                html += `<tr style="cursor: pointer;" onclick="window.open('${p.url}', '_blank')">
                    <td class="discount" style="background-color: hsl(${hue}, 80%, 85%);">${p.discount}%</td>
                    <td>${p.name}</td>
                    <td>${gender}</td>
                    <td>${getCategory(p)}</td>
                    <td>${p.sizes.join(', ')}</td>
                    <td>${salePrice}</td>
                    <td><s>${regularPrice}</s></td>
                    <td class="spacer"></td>
                </tr>`;
            });
            return html + '</tbody></table>';
        }

        function renderUI() {
            const group_by = document.getElementById('group_by').value;
            groupedProducts.clear();
            const { type, groups } = getGroupedData(group_by, currentProducts);
            
            let skeletonHTML = '';
            if (type === 'nested') {
                Object.entries(groups).forEach(([outer, inners]) => {
                    const outerId = `group_${outer.replace(/\W/g, '_')}`;
                    const outerCount = Object.values(inners).reduce((sum, prods) => sum + prods.length, 0);
                    skeletonHTML += `<div class="group-header group-outer" onclick="toggleSection('${outerId}')"><span class="toggle" data-toggle="${outerId}">+</span>${outer} (${outerCount})</div><div id="${outerId}" class="hidden">`;
                    Object.entries(inners).forEach(([inner, products]) => {
                        const innerId = `${outerId}_${inner.replace(/\W/g, '_')}`;
                        groupedProducts.set(innerId, products);
                        skeletonHTML += `<div class="group-header group-inner" onclick="toggleSection('${innerId}')"><span class="toggle" data-toggle="${innerId}">+</span>${inner} (${products.length})</div><div id="${innerId}" class="product-list hidden"></div>`;
                    });
                    skeletonHTML += `</div>`;
                });
            } else { // Flat grouping
                Object.entries(groups).forEach(([key, products]) => {
                    const keyId = `group_${key.replace(/\W/g, '_')}`;
                    groupedProducts.set(keyId, products);
                    skeletonHTML += `<div class="group-header group-outer" onclick="toggleSection('${keyId}')"><span class="toggle" data-toggle="${keyId}">+</span>${key} (${products.length})</div><div id="${keyId}" class="product-list hidden"></div>`;
                });
            }
            document.getElementById('nested-list').innerHTML = skeletonHTML;
            document.getElementById('stats-p').textContent = `Found: ${currentProducts.length.toLocaleString('en-US')} items`;

            expandedIds.forEach(id => {
                const section = document.getElementById(id);
                if (section) { toggleSection(id); }
            });
        }

        async function loadDataAndRender() {
            const stats = document.getElementById('stats-p');
            const progress = document.getElementById('progress-container');
            
            stats.textContent = 'Loading...';
            progress.style.display = 'block';

            const params = new URLSearchParams(window.location.search);
            try {
                const response = await fetch(`/data?${params.toString()}`);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                currentProducts = await response.json();
                renderUI();
            } catch (error) {
                console.error("Failed to load data:", error);
                stats.textContent = 'Error loading data.';
            } finally {
                progress.style.display = 'none';
            }
        }
        
        function handleFormChange() {
            const form = document.querySelector("form");
            const params = new URLSearchParams(new FormData(form));
            history.pushState({}, '', `?${params.toString()}`);
            loadDataAndRender();
        }

        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            document.querySelectorAll("form [name]").forEach(el => {
                if (params.has(el.name)) el.value = params.get(el.name);
            });
            document.querySelectorAll("input, select").forEach(e => e.addEventListener("change", handleFormChange));
            loadDataAndRender();
        });
    </script>
</head>
<body>
    <h1>clothing.deals</h1>
    <form onsubmit="event.preventDefault(); handleFormChange();">
        <div class="filter-group">
            <div><label for="gender">Gender</label><select name="gender" id="gender"><option value="all">All</option><option value="men">Men</option><option value="women">Women</option></select></div>
            <div><label for="group_by">Group By</label><select name="group_by" id="group_by"><option value="category_brand">Category > Brand</option><option value="brand_category">Brand > Category</option><option value="category">Category</option><option value="brand">Brand</option></select></div>
            <div><label for="sort_by">Sort By</label><select name="sort_by" id="sort_by"><option value="discount_desc">Discount (High-Low)</option><option value="price_asc">Price (Low-High)</option></select></div>
        </div>
        <div class="filter-group">
            <div><label for="brands">Brands (comma)</label><input type="text" name="brands" id="brands"></div>
            <div><label for="min_discount">Min Discount</label><input type="text" name="min_discount" id="min_discount" maxlength="2"></div>
        </div>
        <div class="filter-group">
            <div><label for="min_price">Min Price</label><input type="text" name="min_price" id="min_price"></div>
            <div><label for="max_price">Max Price</label><input type="text" name="max_price" id="max_price"></div>
            <div><label for="sizes">Sizes (comma)</label><input type="text" name="sizes" id="sizes"></div>
        </div>
    </form>
    <div class="results-header"><h2>Results</h2><div class="progress-container" id="progress-container"><div class="progress-bar"></div></div><p id="stats-p">Loading...</p></div>
    <div class="nested-list" id="nested-list"></div>
</body>
</html>